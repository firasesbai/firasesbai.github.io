<!DOCTYPE html>
<html lang="en">
  
  <!-- Cookie Consent CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

  <!-- D3js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

<!-- MailerLite Universal -->
<script>
  (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
  .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
  n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
  (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
  ml('account', '1240462');
</script>
<!-- End MailerLite Universal --><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Prometheus Monitoring: How to Collect and Analyze Metrics | Firas Esbai</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Prometheus Monitoring: How to Collect and Analyze Metrics" />
<meta name="author" content="Firas Esbai" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this article we will deep dive into prometheus and see how to create a custom metric for a simple python application" />
<meta property="og:description" content="In this article we will deep dive into prometheus and see how to create a custom metric for a simple python application" />
<link rel="canonical" href="https://www.firasesbai.com/articles/2023/01/15/prometheus-monitoring.html" />
<meta property="og:url" content="https://www.firasesbai.com/articles/2023/01/15/prometheus-monitoring.html" />
<meta property="og:site_name" content="Firas Esbai" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-01-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Prometheus Monitoring: How to Collect and Analyze Metrics" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Firas Esbai"},"description":"In this article we will deep dive into prometheus and see how to create a custom metric for a simple python application","url":"https://www.firasesbai.com/articles/2023/01/15/prometheus-monitoring.html","@type":"BlogPosting","headline":"Prometheus Monitoring: How to Collect and Analyze Metrics","dateModified":"2023-01-15T00:00:00+00:00","datePublished":"2023-01-15T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.firasesbai.com/articles/2023/01/15/prometheus-monitoring.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://www.firasesbai.com/feed.xml" title="Firas Esbai" /><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id='G-3ET85T3WD3'"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3ET85T3WD3');
</script>
</head>
<!-- insert favicons. use https://realfavicongenerator.net/ -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png?v=1">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg?v=1" color="#5bbad5">
  <link rel="shortcut icon" href="/assets/favicon/favicon.ico?v=1">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <!-- service Worker Logic -->	
  <script type="text/javascript" src="/js/service-worker.js"></script>
  
  
  	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id='G-3ET85T3WD3'"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3ET85T3WD3');
</script>

  
  
  <body><header class="site-header" role="banner">
   <div class="wrapper"><a class="site-title" href="/" style="font-size: 26px"> Firas Esbai </a><nav class="site-nav">
         <input type="checkbox" id="nav-trigger" class="nav-trigger" />
         <label for="nav-trigger">
            <span class="menu-icon">
               <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
               </svg>
            </span>
         </label>
         <div class="trigger">
            <!--
               my_page.autogen is populated by the pagination logic for all pages
                               that are automatically created by the gem. Check for non-existence to exclude pagination pages from site.pages iterators
               -->
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
                  <a class="page-link" href="/blog/index.html" style="font-size: 20px">Blog</a>
               
            
               
                  <a class="page-link" href="/contact/" style="font-size: 20px">Contact Me</a>
               
            

         </div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <link rel="stylesheet" href="/assets/css/post.css">

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <nav aria-label="breadcrumb">
    <p class="breadcrumb">
      <a href="/blog">Blog</a>
      
        
        
        > <a href="/categories/observability">Observability</a>
      
      > <span>Prometheus Monitoring: How to Collect and Analyze Metrics</span>
    </p>
  </nav>

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Prometheus Monitoring: How to Collect and Analyze Metrics</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-01-15T00:00:00+00:00" itemprop="datePublished">
        Jan 15, 2023 - 
      </time>
      
      <span class="reading-time" title="Estimated read time">
  
  6 min read
</span>
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"> - Firas Esbai</span></span></p></header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><em>In this article we will deep dive into prometheus, the open-source monitoring and alerting system, and see how we can use it to monitor a simple python application.</em></p>

<p>All the source code is available <a href="https://github.com/firasesbai/fastapi-prometheus-monitoring">here</a>.</p>

<p><em>So let’s get started!</em></p>

<hr />

<h1> Contents </h1>
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ul>
      <li><a href="#prometheus-architecture" id="markdown-toc-prometheus-architecture">Prometheus Architecture</a></li>
    </ul>
  </li>
  <li><a href="#collecting-and-storing-metrics" id="markdown-toc-collecting-and-storing-metrics">Collecting and Storing Metrics</a></li>
  <li><a href="#integrating-with-other-tools" id="markdown-toc-integrating-with-other-tools">Integrating with Other Tools</a></li>
  <li><a href="#implementation" id="markdown-toc-implementation">Implementation</a>    <ul>
      <li><a href="#set-up" id="markdown-toc-set-up">Set up</a></li>
    </ul>
  </li>
  <li><a href="#recap" id="markdown-toc-recap">Recap</a></li>
  <li><a href="#resources" id="markdown-toc-resources">Resources</a></li>
</ul>
<hr />

<h2 id="introduction">Introduction</h2>

<p>Prometheus is an open-source monitoring and alerting system. 
It is often used to monitor the performance of various systems and services, and can send alerts if certain thresholds are exceeded. 
Prometheus also has a powerful query language that can be used to analyze the data it collects.</p>

<p>Prometheus uses a pull model to collect metrics from targets. 
This means that Prometheus actively scrapes metrics from specified targets at regular intervals, rather than waiting for the targets to push metrics to it.</p>

<h3 id="prometheus-architecture">Prometheus Architecture</h3>

<p>The main components of Prometheus are:</p>

<ul>
  <li><strong>Prometheus Server</strong>: This is the core component of Prometheus. It is responsible for scraping metrics from specified targets, storing metrics in its built-in time-series database, and processing and answering queries via PromQL.</li>
  <li><strong>Target</strong>: A target is a system or service that Prometheus scrapes metrics from. Targets typically expose metrics in a specific format over HTTP, which Prometheus can understand.</li>
  <li><strong>Time-Series Database</strong>: Prometheus stores all the metrics it collects in its built-in time-series database. This allows Prometheus to quickly query and analyze metrics, and to provide historical data.</li>
  <li><strong>PromQL</strong>: Prometheus has a powerful query language called PromQL, which can be used to retrieve and analyze metrics stored in its database. PromQL allows you to filter and aggregate metrics, and to create complex queries and alerts.</li>
  <li><strong>Alertmanager</strong>: Prometheus has a built-in alerting system called Alertmanager that can be used to trigger alerts based on metrics and send notifications through various channels.</li>
  <li><strong>Exporters</strong>: Prometheus exporters are third-party tools that convert metrics from various systems and technologies into a format that Prometheus can understand. This allows Prometheus to scrape metrics from a wide variety of sources, such as JMX for Java applications, StatsD, SNMP, and more. For more details, check this blog <a href="https://www.firasesbai.com/articles/2021/01/01/kafka-monitoring.html">post</a> on how to use JMX exporter to monitor an apache kafka cluster.</li>
</ul>

<p>These components work together in the following way:</p>

<p>The prometheus server scrapes metrics from specified targets, stores the metrics in its built-in time-series database, and uses PromQL to process and answer queries. 
The Alertmanager is used to trigger alerts based on metrics and send notifications. 
In addition, exporters can be used to convert metrics from various systems and technologies into a format that Prometheus can understand.</p>

<h2 id="collecting-and-storing-metrics">Collecting and Storing Metrics</h2>

<p>Prometheus periodically scrapes metrics from specified targets, which are typically the applications or services that you want to monitor. 
These targets expose metrics in a specific format, usually over HTTP, that Prometheus can understand.</p>

<p>Prometheus supports several types of metrics:</p>

<ul>
  <li><strong>Counter</strong>: A cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart.</li>
  <li><strong>Gauge</strong>: A metric that represents a single numerical value that can arbitrarily go up and down.</li>
  <li><strong>Histogram</strong>: A metric that samples observations (usually things like request durations or response sizes) and counts them in configurable buckets. It also provides a sum of all observed values.</li>
  <li><strong>Summary</strong>: Similar to a histogram, a summary samples observations and provides both the sum of all observed values and the number of observations.</li>
  <li><strong>Untyped</strong>: A catch-all metric type that can be used to represent any sort of value.</li>
  <li><strong>Vector</strong>: A collection of metrics with the same name and type, but with different labels. This allows users to aggregate and select time series based on their labels.</li>
</ul>

<p>Prometheus also supports the concept of <strong>labels</strong>, which are key-value pairs that can be added to metrics to provide more context. 
Labels can be used to group and filter metrics, making it easy to identify trends and patterns in the data.</p>

<h2 id="integrating-with-other-tools">Integrating with Other Tools</h2>

<p>There are several popular tools that can integrate with Prometheus:</p>

<ul>
  <li><strong>Grafana</strong>: A popular open-source visualization and dashboarding tool that can be used to create interactive and informative charts and graphs based on Prometheus metrics.</li>
  <li><strong>Kapacitor</strong>: A data processing engine that can be used to perform calculations on Prometheus metrics in real-time, such as anomaly detection or aggregations.</li>
  <li><strong>Thanos</strong>: A set of components that can be used to scale Prometheus and make it highly available, by providing features such as long-term storage and querying across multiple Prometheus instances.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>In our <a href="https://github.com/firasesbai/fastapi-prometheus-monitoring">example</a>, we created a simple python application using fastapi. 
Our application has two endpoints; one that returns the prometheus metrics and another one that returns a random fact about cats. 
When querying the latter, we also show how to create your own prometheus metrics by measuring the number of times our endpoint was triggered. 
This is an example of a metric of type counter.</p>

<h3 id="set-up">Set up</h3>

<p>1- Clone this Github <a href="https://github.com/firasesbai/fastapi-prometheus-monitoring">repository</a>, change into the corresponding directory and run the following command: <code class="language-plaintext highlighter-rouge">docker-compose up -d</code></p>

<p>This will start two docker containers: one corresponding to the <em>prometheus service</em> and the other is our python application container called <em>fastapi-app</em>.</p>

<p>2- Access the prometheus dashboard in your web browser through: <code class="language-plaintext highlighter-rouge">http://localhost:9090/targets</code> where you will see our python application as a target for the prometheus service to monitor as shown in the screenshot below:</p>

<figure>
  <img src="/assets/images/articles/9_prometheus_interface.png" alt="image of the prometheus web interfaces showing list of target endpoints" />
  <figcaption>Figure 1: Prometheus Web Interface</figcaption>
</figure>

<p>3- Go to <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8000/docs</code> where you will see the Swagger UI of our python application.</p>

<figure>
  <img src="/assets/images/articles/9_fastapi_swagger_ui.png" alt="swagger ui of a fastapi application containing two endpoints" />
  <figcaption>Figure 2: FastAPI Swagger UI</figcaption>
</figure>

<p>As indicated in the screenshot above, our application has two endpoints:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">/metrics</code>: Makes the monitoring metrics available for prometheus to scrape</li>
  <li><code class="language-plaintext highlighter-rouge">/cat_facts</code>: Returns a random fact about cats.</li>
</ul>

<p>As mentioned when triggering the last endpoint, we calculate in the background a prometheus metric called: <code class="language-plaintext highlighter-rouge">random_facts_api_execution_counter</code> which measures the number of times this endpoint was triggered.</p>

<p>When we request the <code class="language-plaintext highlighter-rouge">/metrics</code> endpoint, we see a list of metrics measuring several things such as the <em>request time</em>, <em>python garbage collection objects</em>, etc…</p>

<p>These metrics were made available by adding the <strong>prometheus middleware</strong> to our application. 
  In addition, we can also see our own created metric as shown below:</p>

<figure>
  <img src="/assets/images/articles/9_custom_prometheus_metric.png" alt="an example counter of prometheus metric" />
  <figcaption>Figure 3: Custom Prometheus Metrics Example</figcaption>
</figure>

<p>That’s it! You have successfully created a custom metric in your python application and you were able to scrape it and make it visible to prometheus.</p>

<p>With this we have reached the end of this post, I hope you enjoyed it!</p>

<h2 id="recap">Recap</h2>

<p>In this blog post, we discussed Prometheus monitoring, a widely used and powerful monitoring and alerting system. 
We covered topics such as Prometheus architecture, how to collect the different types of metrics and gave an example of popular tools that can integrate with Prometheus. 
In addition, we went through an example of how to deploy a python application in which we created a custom metric and we were able to scrap it and visualize it using prometheus.</p>

<p><em>Happy learning!</em></p>

<h2 id="resources">Resources</h2>

<p><a href="https://prometheus.io/docs/introduction/overview/">https://prometheus.io/docs/introduction/overview/</a></p>

<p><a href="https://grafana.com/grafana/">https://grafana.com/grafana/</a></p>

<p><a href="https://docs.influxdata.com/kapacitor/v1.6/working/scraping-and-discovery/">https://docs.influxdata.com/kapacitor/v1.6/working/scraping-and-discovery/</a></p>

<p><a href="https://thanos.io/">https://thanos.io/</a></p>

  </div>

  <hr>
<br>
<div class="ml-embedded" data-form="T82iSQ"></div>

  <br>
<hr>
<br>
<div id="relatedPosts">
   <div class="post-header bg-">
      <h1 class="page-heading">Further Reading</h1>
   </div>
   
   
   
   
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2022/01/09/logging-with-elasticsearch.html">Logging with ELK Stack</a></h3>
    </div>
    
    
   
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2021/02/07/kafka-monitoring-part-2.html">Essential Kafka Cluster Metrics: A Comprehensive Monitoring Guide</a></h3>
    </div>
    
    
   
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2021/01/01/kafka-monitoring.html">Navigating Apache Kafka Monitoring in Real-World Deployments</a></h3>
    </div>
    
    
   
   
</div>

  
    
<hr>
<br>
<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://firasesbai.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

  <a class="u-url" href="/articles/2023/01/15/prometheus-monitoring.html" hidden></a>
</article>
      </div>
    </main><link rel="stylesheet" href="/assets/css/footer.css">
 
<footer class="site-footer h-card">
   <data class="u-url" href="/"></data>
   <div class="wrapper">
      <div class="footer-col-wrapper">
         <div class="footer-col footer-col-1" style="text-align: left;"><ul class="social-media-list"><li><a href="https://www.firasesbai.com/feed.xml"><svg class="svg-icon orange"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg><span> Subscribe</span></a></li><li><a href="https://www.linkedin.com/in/firas-esbai"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">firas-esbai</span></a></li><li><a href="https://github.com/firasesbai"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">firasesbai</span></a></li></ul></div>
         <div class="footer-col footer-col-2" style="text-align: right;">
            <ul class="legal-list" style="list-style-type: none; padding: 0;">
               <li><a href="/archive/">Archive</a></li>
               <li><a href="/privacy-policy/">Privacy Policy</a></li>
               <li><a href="/terms/">Terms and Conditions</a></li>
            </ul>
         </div>
      </div>
      <div style="text-align: center; margin-top: 10px;">
         
            <p class="p-name">Copyright &copy; 2024 Firas Esbai.</p>
            
      </div>
   </div>
</footer><!-- Cookie Consent Logic -->	
	<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
	<script src="/js/cookie-consent-script.js" type="text/javascript"> </script>

  </body>

</html>