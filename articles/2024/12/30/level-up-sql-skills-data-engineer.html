<!DOCTYPE html>
<html lang="en">
  
  <!-- Cookie Consent CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

  <!-- D3js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

<!-- MailerLite Universal -->
<script>
  (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
  .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
  n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
  (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
  ml('account', '1240462');
</script>
<!-- End MailerLite Universal --><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Level Up Your SQL Skills As a Data Engineer | Firas Esbai</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Level Up Your SQL Skills As a Data Engineer" />
<meta name="author" content="Firas Esbai" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="overview of sql topics with example queries for data engineers" />
<meta property="og:description" content="overview of sql topics with example queries for data engineers" />
<link rel="canonical" href="https://www.firasesbai.com/articles/2024/12/30/level-up-sql-skills-data-engineer.html" />
<meta property="og:url" content="https://www.firasesbai.com/articles/2024/12/30/level-up-sql-skills-data-engineer.html" />
<meta property="og:site_name" content="Firas Esbai" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Level Up Your SQL Skills As a Data Engineer" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Firas Esbai"},"description":"overview of sql topics with example queries for data engineers","url":"https://www.firasesbai.com/articles/2024/12/30/level-up-sql-skills-data-engineer.html","@type":"BlogPosting","headline":"Level Up Your SQL Skills As a Data Engineer","dateModified":"2024-12-30T00:00:00+00:00","datePublished":"2024-12-30T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.firasesbai.com/articles/2024/12/30/level-up-sql-skills-data-engineer.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://www.firasesbai.com/feed.xml" title="Firas Esbai" /><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id='G-3ET85T3WD3'"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3ET85T3WD3');
</script>
</head>
<!-- insert favicons. use https://realfavicongenerator.net/ -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png?v=1">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg?v=1" color="#5bbad5">
  <link rel="shortcut icon" href="/assets/favicon/favicon.ico?v=1">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <!-- service Worker Logic -->	
  <script type="text/javascript" src="/js/service-worker.js"></script>
  
  
  	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id='G-3ET85T3WD3'"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3ET85T3WD3');
</script>

  
  
  <body><header class="site-header" role="banner">
   <div class="wrapper"><a class="site-title" href="/" style="font-size: 26px"> Firas Esbai </a><nav class="site-nav">
         <input type="checkbox" id="nav-trigger" class="nav-trigger" />
         <label for="nav-trigger">
            <span class="menu-icon">
               <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
               </svg>
            </span>
         </label>
         <div class="trigger">
            <!--
               my_page.autogen is populated by the pagination logic for all pages
                               that are automatically created by the gem. Check for non-existence to exclude pagination pages from site.pages iterators
               -->
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
            
               
                  <a class="page-link" href="/blog/index.html" style="font-size: 20px">Blog</a>
               
            
               
                  <a class="page-link" href="/contact/" style="font-size: 20px">Contact Me</a>
               
            

         </div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <link rel="stylesheet" href="/assets/css/post.css">

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <nav aria-label="breadcrumb">
    <p class="breadcrumb">
      <a href="/blog">Blog</a>
      
        
        
        > <a href="/categories/data-engineering">Data Engineering</a>
      
      > <span>Level Up Your SQL Skills As a Data Engineer</span>
    </p>
  </nav>

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Level Up Your SQL Skills As a Data Engineer</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-12-30T00:00:00+00:00" itemprop="datePublished">
        Dec 30, 2024 - 
      </time>
      
      <span class="reading-time" title="Estimated read time">
  
  15 min read
</span>
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"> - Firas Esbai</span></span></p></header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><em>Mastering SQL and understanding what can be done with it is crucial in making you a better data engineer.</em></p>

<p>This article is your starting point to leveling up your SQL skills. We will start with a refresher and then move on to more advanced topics and optimizations techniques all packed with concrete examples and a final case study to wrap it all up.</p>

<p><em>So let’s get started!</em></p>

<hr />

<h1> Contents </h1>
<ul id="markdown-toc">
  <li><a href="#sql-overview" id="markdown-toc-sql-overview">SQL Overview</a></li>
  <li><a href="#sql-query-order-of-execution" id="markdown-toc-sql-query-order-of-execution">SQL Query Order of Execution</a></li>
  <li><a href="#advanced-slq" id="markdown-toc-advanced-slq">Advanced SLQ</a></li>
  <li><a href="#subquery-vs-cte-vs-temp-table" id="markdown-toc-subquery-vs-cte-vs-temp-table">Subquery vs CTE vs Temp Table</a>    <ul>
      <li><a href="#what-is-a-subquery" id="markdown-toc-what-is-a-subquery">What is a Subquery?</a></li>
      <li><a href="#what-is-a-cte" id="markdown-toc-what-is-a-cte">What is a CTE?</a></li>
      <li><a href="#what-is-a-temp-table" id="markdown-toc-what-is-a-temp-table">What is a Temp Table?</a></li>
    </ul>
  </li>
  <li><a href="#window-functions" id="markdown-toc-window-functions">Window Functions</a>    <ul>
      <li><a href="#so-what-exactly-are-window-functions" id="markdown-toc-so-what-exactly-are-window-functions">So what exactly are Window functions?</a></li>
      <li><a href="#breakdown-of-window-functions" id="markdown-toc-breakdown-of-window-functions">Breakdown of Window functions</a></li>
    </ul>
  </li>
  <li><a href="#sql-query-optimization-techniques" id="markdown-toc-sql-query-optimization-techniques">SQL Query Optimization Techniques</a></li>
  <li><a href="#case-study-nyc-citi-bike-trips" id="markdown-toc-case-study-nyc-citi-bike-trips">Case Study: NYC Citi Bike Trips</a></li>
  <li><a href="#recap" id="markdown-toc-recap">Recap</a></li>
  <li><a href="#resources" id="markdown-toc-resources">Resources</a></li>
</ul>
<hr />

<h2 id="sql-overview">SQL Overview</h2>

<p>There are 5 components of the SQL language:</p>

<ul>
  <li><strong>Data Definition Language (DDL)</strong>: Used to define the structure that holds the data. It includes commands like:
    <ul>
      <li>CREATE: Used to create objects in the database (e.g., tables).</li>
      <li>ALTER: Used to modify the structure of an existing database object.</li>
      <li>DROP: Used to delete objects from the database.</li>
    </ul>
  </li>
  <li><strong>Data Manipulation Language (DML)</strong>: deals with the manipulation of the data itself. Common DML commands include:
    <ul>
      <li>INSERT: Used to add new rows of data into a table.</li>
      <li>UPDATE: Used to modify existing data within a table.</li>
      <li>DELETE: Used to remove rows from a table.</li>
    </ul>
  </li>
  <li><strong>Data Control Language (DCL)</strong>: concerned with the rights, permissions, and other controls of the database system. It includes commands like:
    <ul>
      <li>GRANT: Gives users access privileges to database.</li>
      <li>REVOKE: Takes back privileges granted with the GRANT command.</li>
    </ul>
  </li>
  <li><strong>Transaction Control Language (TCL)</strong>: deals with transactions within a database. Transactions allow for control over groups of SQL statements. Common TCL commands include:
    <ul>
      <li>COMMIT: Saves changes made during the current transaction.</li>
      <li>ROLLBACK: Restores the database to its original state since the last COMMIT.</li>
    </ul>
  </li>
  <li><strong>Data Query Language (DQL)</strong>: used to retrieve data from the database. The primary command in DQL is:
    <ul>
      <li>SELECT: Retrieves data from one or more tables.</li>
    </ul>
  </li>
</ul>

<p>These components together provide a comprehensive set of tools to interact with and manage databases using SQL.</p>

<h2 id="sql-query-order-of-execution">SQL Query Order of Execution</h2>

<p>For a given SQL query, the SQL engine will execute its clauses in a specific standard order in order to process your query and return the desired results.</p>

<p>Understanding the order in which a SQL query is executed is important and will allow you to optimize your queries by minimizing the amount of data processed and improving query execution times. In addition, it will result in writing better and more efficient queries which consume less resources and lead to faster response times and less constraints on the database server.</p>

<p>The following table summarizes the SQL query order of execution:</p>

<table>
  <thead>
    <tr>
      <th>Order</th>
      <th style="text-align: left">Clause</th>
      <th style="text-align: left">Function</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td style="text-align: left">From/Join</td>
      <td style="text-align: left">Determines table(s) from which data will be queried</td>
    </tr>
    <tr>
      <td>2</td>
      <td style="text-align: left">Where</td>
      <td style="text-align: left">Filters data on rows</td>
    </tr>
    <tr>
      <td>3</td>
      <td style="text-align: left">Group By</td>
      <td style="text-align: left">Checks if you have aggregations</td>
    </tr>
    <tr>
      <td>4</td>
      <td style="text-align: left">Having</td>
      <td style="text-align: left">Filters data based on specified groups</td>
    </tr>
    <tr>
      <td>5</td>
      <td style="text-align: left">Select</td>
      <td style="text-align: left">Selects which columns you want to see returned</td>
    </tr>
    <tr>
      <td>6</td>
      <td style="text-align: left">Order By</td>
      <td style="text-align: left">Sorts the data returned</td>
    </tr>
    <tr>
      <td>7</td>
      <td style="text-align: left">Limit</td>
      <td style="text-align: left">Limits the number of rows returned</td>
    </tr>
  </tbody>
</table>

<p style="text-align:center;">Table 1: SQL query order of execution</p>

<h2 id="advanced-slq">Advanced SLQ</h2>

<h2 id="subquery-vs-cte-vs-temp-table">Subquery vs CTE vs Temp Table</h2>

<h3 id="what-is-a-subquery">What is a Subquery?</h3>

<p>Subquery, also known as inner query, is a query nested inside another SQL query. Subqueries are enclosed within parentheses and can be placed in various parts of a SQL statement such as the SELECT, FROM, WHERE, or HAVING clauses.</p>

<p>Example:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">   
<span class="no">CREATE</span> <span class="no">TABLE</span> <span class="n">departments</span> <span class="p">(</span><span class="nb">id</span> <span class="no">INT</span><span class="p">,</span> <span class="nb">name</span> <span class="no">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>

<span class="no">CREATE</span> <span class="no">TABLE</span> <span class="n">employees</span> <span class="p">(</span>
   <span class="nb">id</span> <span class="no">INT</span><span class="p">,</span> 
   <span class="nb">name</span> <span class="no">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> 
   <span class="n">salary</span> <span class="no">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
   <span class="n">department_id</span> <span class="no">INT</span><span class="p">);</span>

<span class="no">INSERT</span> <span class="no">INTO</span> <span class="n">departments</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
<span class="no">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'HR'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Finance'</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Marketing'</span><span class="p">);</span>

<span class="no">INSERT</span> <span class="no">INTO</span> <span class="n">employees</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">salary</span><span class="p">,</span> <span class="n">department_id</span><span class="p">)</span>
<span class="no">VALUES</span> 
   <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'John Doe'</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
   <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Jane Smith'</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
   <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Alice Johnson'</span><span class="p">,</span> <span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
   <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'Bob Williams'</span><span class="p">,</span> <span class="mi">55000</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></code></pre></figure>

<p>Suppose we want to retrieve all the employees that work in <strong>HR</strong> department:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">   
<span class="no">SELECT</span> <span class="nb">id</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">salary</span>
<span class="no">FROM</span> <span class="n">employees</span>
<span class="no">WHERE</span> <span class="n">department_id</span> <span class="o">=</span> <span class="p">(</span>
	<span class="no">SELECT</span> <span class="nb">id</span> <span class="no">FROM</span> <span class="n">departments</span> <span class="no">WHERE</span> <span class="nb">name</span> <span class="o">=</span> <span class="s1">'HR'</span>
<span class="p">);</span></code></pre></figure>

<p>Subqueries are a powerful feature of SQL allowing for more complex and dynamic queries by enabling you to use the results of one query as a condition or value in another.</p>

<h3 id="what-is-a-cte">What is a CTE?</h3>

<p>CTE stands for Common Table Expression. It is a named temporary result set that exist only for the duration of the main query.</p>

<p><em>Basic Syntax:</em></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="o">--</span> <span class="no">Start</span> <span class="n">of</span> <span class="n">a</span> <span class="no">CTE</span>
<span class="no">WITH</span> <span class="n">cte_name</span> <span class="no">AS</span> <span class="p">(</span>
	<span class="o">--</span> <span class="no">CTE</span> <span class="n">query</span> <span class="n">definition</span> <span class="n">here</span>
	<span class="no">SELECT</span> <span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="o">...</span>
	<span class="no">FROM</span> <span class="n">table_name</span>
	<span class="no">WHERE</span> <span class="n">conditions</span>
<span class="p">)</span>
<span class="o">--</span> <span class="k">END</span> <span class="n">of</span> <span class="n">a</span> <span class="no">CTE</span> 
<span class="no">SELECT</span> <span class="o">*</span>
<span class="no">FROM</span> <span class="n">cte_name</span><span class="p">;</span></code></pre></figure>

<p>CTEs are useful for improving the readability and maintainability of complex queries. In addition, when you need to use the same subquery result multiple times within a larger query, it avoids duplicating complex logic and can make queries more readable and easier to maintain.</p>

<h3 id="what-is-a-temp-table">What is a Temp Table?</h3>

<p>A temporary table in SQL is a table that exists temporarily on the database server.</p>

<p>Unlike CTEs that exist only in the context of the query in which they are defined, Temp tables can be created and used just like regular database tables, but they are dropped automatically when the session ends or when explicitly dropped by the user.</p>

<p>Temp Tables are useful for holding intermediate results that you want to reuse multiple times within a session and allow to break down complex tasks into smaller, more manageable tasks.</p>

<h2 id="window-functions">Window Functions</h2>

<p>SQL Window functions show up in pretty much every data engineering interview nowadays. Therefore, it is important to understand the key concepts related to this powerful feature.</p>

<h3 id="so-what-exactly-are-window-functions">So what exactly are Window functions?</h3>

<p>Window functions allow you to perform calculations across a set of table rows related to the current row. This is different from aggregate functions, which summarize data into a single output row for each group.</p>

<h3 id="breakdown-of-window-functions">Breakdown of Window functions</h3>

<ol>
  <li><strong>Partitioning</strong>: Window functions are typically used with an <strong>OVER clause</strong>, which defines the window of rows over which the function will operate. This clause can partition the result set into groups of rows based on one or more column values.</li>
  <li><strong>Ordering</strong>: Within each partition, you can specify an <strong>ORDER BY</strong> clause to define the order in which the rows are processed by the window function.</li>
  <li><strong>Window Frame</strong>: This defines the subset of rows within the partition to which the function is applied. The frame can be defined as rows preceding or following the current row, or between a range of rows.</li>
</ol>

<p>There are two main categories of window functions:</p>
<ul>
  <li>
    <p><strong>Aggregate Window Functions:</strong> These functions resemble regular aggregate functions (SUM, COUNT, AVG, etc.) but operate within the window instead of across the entire dataset. This allows you to calculate things like <strong>running totals</strong> or <strong>moving averages</strong>.</p>

    <p>Commonly used SQL Aggregate Window Functions include:</p>

    <ul>
      <li><strong>COUNT</strong>() counts the number of rows in a specified column across a defined window.</li>
      <li><strong>SUM</strong>() computes the sum of values within a specified column across a defined window.</li>
      <li><strong>AVG</strong>() calculates the average of a selected group of values across a defined window.</li>
      <li><strong>MIN</strong>() retrieves the lowest value from a particular column across a defined window.</li>
      <li><strong>MAX</strong>() fetches the highest value from a specific column across a defined window.</li>
      <li><strong>FIRST_VALUE</strong>() returns the first value in a designated column across a defined window.</li>
      <li><strong>LAST_VALUE</strong>() provides the last value in a given column across a defined window.</li>
    </ul>
  </li>
  <li>
    <p><strong>Ranking Window Functions:</strong> These functions assign a rank or order to each row based on a specified value. Examples include ROW_NUMBER(), RANK(), and DENSE_RANK(). These are useful for identifying <strong>top performers</strong>, assigning <strong>unique sequential identifiers</strong>, or <strong>grouping data into buckets</strong>.</p>
  </li>
</ul>

<p>To better illustrate the syntax of the window function, let’s take the following example:</p>

<p>Suppose we have a table <strong>employees</strong>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">CREATE</span> <span class="no">TABLE</span> <span class="n">employees</span> <span class="p">(</span>
    <span class="n">emp_id</span> <span class="no">INT</span><span class="p">,</span>
    <span class="n">emp_name</span> <span class="no">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">department</span> <span class="no">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">salary</span> <span class="no">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">);</span>

<span class="no">INSERT</span> <span class="no">INTO</span> <span class="n">employees</span> <span class="p">(</span><span class="n">emp_id</span><span class="p">,</span> <span class="n">emp_name</span><span class="p">,</span> <span class="n">department</span><span class="p">,</span> <span class="n">salary</span><span class="p">)</span>
<span class="no">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Alice'</span><span class="p">,</span> <span class="s1">'HR'</span><span class="p">,</span> <span class="mf">50000.00</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Bob'</span><span class="p">,</span> <span class="s1">'HR'</span><span class="p">,</span> <span class="mf">60000.00</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Charlie'</span><span class="p">,</span> <span class="s1">'Engineering'</span><span class="p">,</span> <span class="mf">70000.00</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'David'</span><span class="p">,</span> <span class="s1">'Engineering'</span><span class="p">,</span> <span class="mf">80000.00</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'Eve'</span><span class="p">,</span> <span class="s1">'Engineering'</span><span class="p">,</span> <span class="mf">90000.00</span><span class="p">);</span></code></pre></figure>

<p>We want to calculate the average salary for each departement:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">SELECT</span>
    <span class="n">emp_id</span><span class="p">,</span>
    <span class="n">emp_name</span><span class="p">,</span>
    <span class="n">department</span><span class="p">,</span>
    <span class="n">salary</span><span class="p">,</span>
    <span class="no">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="no">OVER</span><span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">department</span><span class="p">)</span> <span class="no">AS</span> <span class="n">avg_salary_department</span>
<span class="no">FROM</span>
    <span class="n">employees</span><span class="p">;</span></code></pre></figure>

<p>The result would be:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="n">emp_id</span> <span class="o">|</span> <span class="n">emp_name</span> <span class="o">|</span> <span class="n">department</span>  <span class="o">|</span> <span class="n">salary</span>   <span class="o">|</span> <span class="n">avg_salary_department</span>
<span class="o">------------------------------------------------------------------</span>
<span class="mi">1</span>      <span class="o">|</span> <span class="no">Alice</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">50000.00</span> <span class="o">|</span> <span class="mf">55000.00</span>
<span class="mi">2</span>      <span class="o">|</span> <span class="no">Bob</span>      <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">60000.00</span> <span class="o">|</span> <span class="mf">55000.00</span>
<span class="mi">3</span>      <span class="o">|</span> <span class="no">Charlie</span>  <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mf">80000.00</span>
<span class="mi">4</span>      <span class="o">|</span> <span class="no">David</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mf">80000.00</span>
<span class="mi">5</span>      <span class="o">|</span> <span class="no">Eve</span>      <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">90000.00</span> <span class="o">|</span> <span class="mf">80000.00</span>   </code></pre></figure>

<p>The window function calculates the average salary for each row in the result set, but it doesn’t change the number of rows returned. Each row retains its original data, but we also get a new column with the average salary for the department of that row.</p>

<p>However, using a <strong>Group By</strong>, the result set is reduced to one row per department, where each row represents a distinct department.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">SELECT</span>
    <span class="n">department</span><span class="p">,</span>
    <span class="no">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="no">AS</span> <span class="n">avg_salary_department</span>
<span class="no">FROM</span>
    <span class="n">employees</span>
<span class="no">GROUP</span> <span class="no">BY</span>
    <span class="n">department</span><span class="p">;</span>

<span class="n">department</span>  <span class="o">|</span> <span class="n">avg_salary_department</span>
<span class="o">------------------------------------</span>
<span class="no">HR</span>          <span class="o">|</span> <span class="mf">55000.00</span>
<span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span></code></pre></figure>

<p>To better illustrate the difference between ROW_NUMBER(), RANK(), and DENSE_RANK(), we will update our employees table with the following values:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="n">emp_id</span> <span class="o">|</span> <span class="n">emp_name</span> <span class="o">|</span> <span class="n">department</span>  <span class="o">|</span> <span class="n">salary</span>   
<span class="o">-------------------------------------------</span>
<span class="mi">1</span>      <span class="o">|</span> <span class="no">Alice</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">60000.00</span> 
<span class="mi">2</span>      <span class="o">|</span> <span class="no">Bob</span>      <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> 
<span class="mi">3</span>      <span class="o">|</span> <span class="no">Charlie</span>  <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> 
<span class="mi">4</span>      <span class="o">|</span> <span class="no">David</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> 
<span class="mi">5</span>      <span class="o">|</span> <span class="no">Eve</span>      <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">75000.00</span> 
<span class="mi">6</span>      <span class="o">|</span> <span class="no">Frank</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">70000.00</span>   </code></pre></figure>

<p>Ranking the employees within their departments based on their salaries results in the following queries:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">SELECT</span>
   <span class="n">emp_id</span><span class="p">,</span>
   <span class="n">emp_name</span><span class="p">,</span>
   <span class="n">department</span><span class="p">,</span>
   <span class="n">salary</span><span class="p">,</span>
   <span class="no">ROW_NUMBER</span><span class="p">()</span> <span class="no">OVER</span><span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">department</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">salary</span> <span class="no">DESC</span><span class="p">)</span> <span class="no">AS</span> <span class="n">row_number</span>
<span class="no">FROM</span>
   <span class="n">employees</span><span class="p">;</span>

<span class="n">emp_id</span> <span class="o">|</span> <span class="n">emp_name</span> <span class="o">|</span> <span class="n">department</span>  <span class="o">|</span> <span class="n">salary</span>   <span class="o">|</span> <span class="n">row_number</span>
<span class="o">-------------------------------------------------------</span>
<span class="mi">2</span>      <span class="o">|</span> <span class="no">Bob</span>      <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">6</span>      <span class="o">|</span> <span class="no">Frank</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">2</span>
<span class="mi">1</span>      <span class="o">|</span> <span class="no">Alice</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">60000.00</span> <span class="o">|</span> <span class="mi">3</span>
<span class="mi">3</span>      <span class="o">|</span> <span class="no">Charlie</span>  <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">4</span>      <span class="o">|</span> <span class="no">David</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">2</span>
<span class="mi">5</span>      <span class="o">|</span> <span class="no">Eve</span>      <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">75000.00</span> <span class="o">|</span> <span class="mi">3</span></code></pre></figure>

<p>Each Row has a unique number regardless of ties.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">SELECT</span>
   <span class="n">emp_id</span><span class="p">,</span>
   <span class="n">emp_name</span><span class="p">,</span>
   <span class="n">department</span><span class="p">,</span>
   <span class="n">salary</span><span class="p">,</span>
   <span class="no">RANK</span><span class="p">()</span> <span class="no">OVER</span><span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">department</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">salary</span> <span class="no">DESC</span><span class="p">)</span> <span class="no">AS</span> <span class="n">rank</span>
<span class="no">FROM</span>
   <span class="n">employees</span><span class="p">;</span>

<span class="n">emp_id</span> <span class="o">|</span> <span class="n">emp_name</span> <span class="o">|</span> <span class="n">department</span>  <span class="o">|</span> <span class="n">salary</span>   <span class="o">|</span> <span class="n">rank</span>
<span class="o">--------------------------------------------------</span>
<span class="mi">2</span>      <span class="o">|</span> <span class="no">Bob</span>      <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">6</span>      <span class="o">|</span> <span class="no">Frank</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">1</span>      <span class="o">|</span> <span class="no">Alice</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">60000.00</span> <span class="o">|</span> <span class="mi">3</span>
<span class="mi">3</span>      <span class="o">|</span> <span class="no">Charlie</span>  <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">4</span>      <span class="o">|</span> <span class="no">David</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">5</span>      <span class="o">|</span> <span class="no">Eve</span>      <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">75000.00</span> <span class="o">|</span> <span class="mi">3</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="no">SELECT</span>
   <span class="n">emp_id</span><span class="p">,</span>
   <span class="n">emp_name</span><span class="p">,</span>
   <span class="n">department</span><span class="p">,</span>
   <span class="n">salary</span><span class="p">,</span>
   <span class="no">DENSE_RANK</span><span class="p">()</span> <span class="no">OVER</span><span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">department</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">salary</span> <span class="no">DESC</span><span class="p">)</span> <span class="no">AS</span> <span class="n">dense_rank</span>
<span class="no">FROM</span>
   <span class="n">employees</span><span class="p">;</span>

<span class="n">emp_id</span> <span class="o">|</span> <span class="n">emp_name</span> <span class="o">|</span> <span class="n">department</span>  <span class="o">|</span> <span class="n">salary</span>   <span class="o">|</span> <span class="n">dense_rank</span>
<span class="o">-------------------------------------------------------</span>
<span class="mi">2</span>      <span class="o">|</span> <span class="no">Bob</span>      <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">6</span>      <span class="o">|</span> <span class="no">Frank</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">70000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">1</span>      <span class="o">|</span> <span class="no">Alice</span>    <span class="o">|</span> <span class="no">HR</span>          <span class="o">|</span> <span class="mf">60000.00</span> <span class="o">|</span> <span class="mi">2</span>
<span class="mi">3</span>      <span class="o">|</span> <span class="no">Charlie</span>  <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">4</span>      <span class="o">|</span> <span class="no">David</span>    <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">80000.00</span> <span class="o">|</span> <span class="mi">1</span>
<span class="mi">5</span>      <span class="o">|</span> <span class="no">Eve</span>      <span class="o">|</span> <span class="no">Engineering</span> <span class="o">|</span> <span class="mf">75000.00</span> <span class="o">|</span> <span class="mi">2</span></code></pre></figure>

<p>The difference between RANK and DENSE_RANK is the gaps between the ranking in case of ties. You can check this by looking at the row of Alice and Eve where their rank is 3 with RANK but 2 with DENSE_RANK.</p>

<h2 id="sql-query-optimization-techniques">SQL Query Optimization Techniques</h2>

<p>Since SQL is declarative, there are typically many alternative ways to execute a given query, with widely varying performance. When a query is submitted to the database, the query optimizer evaluates different possible plans or query execution plans which are sequences of steps used to access data. Once determined, the most efficient query is then returned.</p>

<p>Many database systems provide tools to view the query plan, either graphically or in text format. This helps developers understand and optimize query performance.</p>

<p>Regularly reviewing and analyzing query execution plans to understand how queries are executed and identify potential performance issues is very helpful. In addition, knowing and applying other optimization techinques can enahance the performance of your system. Here are some general tips for query optimization:</p>

<ul>
  <li>Use column names instead of * in a SELECT statement. This reduces the amount of data transferred and processed.</li>
  <li>Use the most appropriate and efficient data types for your columns to save space and improve performance.</li>
  <li>Create indexes on columns that are frequently used in WHERE clauses, JOIN conditions, and as part of ORDER BY clauses for faster data retrievel.</li>
  <li>Use appropriate join types(INNER JOIN, LEFT JOIN, RIGHT JOIN, FULL JOIN) and ensure that join conditions are based on indexed columns.</li>
  <li>Consider the order of joins: join smaller tables first to reduce the size of intermediate results.</li>
  <li>Use INNER JOINs where possible as it’s usually faster than OUTER JOINs.</li>
  <li>Use subqueries only when necessary and consider alternatives like JOINs or Common Table Expressions (CTEs) to simplify and optimize complex queries</li>
</ul>

<h2 id="case-study-nyc-citi-bike-trips">Case Study: NYC Citi Bike Trips</h2>

<p>In this section we will try to apply some of the learnings from previous sections to answer some questions about the Citi Bike Trips dataset using SQL.</p>

<p>This dataset contains information about trips of the Citi Bike share program. It is hosted and available in Google BigQuery and included in the free tier processing. For more information, check <a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike?project=propane-cooler-150809">this link</a>.</p>

<p>Each question is followed by the corresponding SQL query and its output. For better readability the output of some queries is limited to 3 rows.</p>

<p>The answer and expected output are hidden. Try to answer the questions to test your understanding before revealing them.</p>

<p><strong>Which trips lasted longer than 30 minutes?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="n">tripduration</span><span class="p">,</span> 
      <span class="n">start_station_name</span><span class="p">,</span> 
      <span class="n">end_station_name</span><span class="p">,</span> 
      <span class="n">bikeid</span><span class="p">,</span> 
      <span class="n">usertype</span> 
   <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> 
   <span class="no">WHERE</span> <span class="n">tripduration</span> <span class="o">&gt;</span> <span class="mi">30</span> 
   <span class="no">LIMIT</span> <span class="mi">3</span><span class="p">;</span>
   
   <span class="n">tripduration</span> <span class="o">|</span> <span class="n">start_station_name</span>      <span class="o">|</span> <span class="n">end_station_name</span>      <span class="o">|</span> <span class="n">bikeid</span> <span class="o">|</span> <span class="n">usertype</span>
   <span class="o">------------------------------------------------------------------------------------</span>
   <span class="mi">16930</span>        <span class="o">|</span> <span class="no">South</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="no">Whitehall</span> <span class="no">St</span> <span class="o">|</span> <span class="no">NYCBS</span> <span class="no">Depot</span> <span class="no">BAL</span> <span class="o">-</span> <span class="no">DYR</span> <span class="o">|</span> <span class="mi">14826</span>  <span class="o">|</span> <span class="no">Subscriber</span>
   <span class="mi">547</span>          <span class="o">|</span> <span class="mi">12</span> <span class="no">Ave</span> <span class="o">&amp;</span> <span class="no">W</span> <span class="mi">40</span> <span class="no">St</span>        <span class="o">|</span> <span class="no">NYCBS</span> <span class="no">Depot</span> <span class="no">BAL</span> <span class="o">-</span> <span class="no">DYR</span> <span class="o">|</span> <span class="mi">22094</span>  <span class="o">|</span> <span class="no">Subscriber</span>
   <span class="mi">442403</span>       <span class="o">|</span> <span class="no">E</span> <span class="mi">10</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="no">Avenue</span> <span class="no">A</span>      <span class="o">|</span> <span class="no">NYCBS</span> <span class="no">Depot</span> <span class="o">-</span> <span class="no">DEL</span>     <span class="o">|</span> <span class="mi">16592</span>  <span class="o">|</span> <span class="no">Customer</span>   
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>What is the average trip duration for each user type (Subscriber and Customer)?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="n">usertype</span><span class="p">,</span> 
      <span class="no">ROUND</span><span class="p">(</span><span class="no">AVG</span><span class="p">(</span><span class="n">tripduration</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="no">AS</span> <span class="n">average_trip_duration</span> 
   <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> 
   <span class="no">GROUP</span> <span class="no">BY</span> <span class="n">usertype</span><span class="p">;</span>
   
   <span class="n">usertype</span>   <span class="o">|</span> <span class="n">average_trip_duration</span>
   <span class="o">----------------------------------</span>
   <span class="no">Subscriber</span> <span class="o">|</span> <span class="mf">806.38</span>  
   <span class="no">Customer</span>   <span class="o">|</span> <span class="mf">2145.51</span> 
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>How many trips were made each day?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="no">DATE</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="no">AS</span> <span class="n">day</span><span class="p">,</span> 
      <span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="no">AS</span> <span class="n">trip_count</span> 
   <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> 
   <span class="no">GROUP</span> <span class="no">BY</span> <span class="n">day</span> 
   <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">day</span><span class="p">;</span>

   <span class="n">day</span>        <span class="o">|</span> <span class="n">trip_count</span>
   <span class="o">-----------------------</span>
   <span class="mi">2013</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mo">01</span> <span class="o">|</span> <span class="mi">16650</span> 
   <span class="mi">2013</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mo">02</span> <span class="o">|</span> <span class="mi">22745</span> 
   <span class="mi">2013</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mo">03</span> <span class="o">|</span> <span class="mi">21864</span> 
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>Which start station has the highest number of trips?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="n">start_station_name</span><span class="p">,</span> 
      <span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">as</span> <span class="n">trip_count</span> 
   <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> 
   <span class="no">GROUP</span> <span class="no">BY</span> <span class="n">start_station_name</span> 
   <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">trip_count</span> <span class="no">DESC</span><span class="p">;</span>

   <span class="n">start_station_name</span>    <span class="o">|</span> <span class="n">trip_count</span>
   <span class="o">----------------------------------</span>
   <span class="no">Pershing</span> <span class="no">Square</span> <span class="no">North</span> <span class="o">|</span> <span class="mi">438077</span> 
   <span class="no">E</span> <span class="mi">17</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="no">Broadway</span>    <span class="o">|</span> <span class="mi">423334</span> 
   <span class="no">W</span> <span class="mi">21</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="mi">6</span> <span class="no">Ave</span>       <span class="o">|</span> <span class="mi">403795</span> 
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>Which stations had more than 1,000 trips starting from them?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="n">start_station_name</span><span class="p">,</span> 
      <span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="no">AS</span> <span class="n">trip_count</span> 
   <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> 
   <span class="no">GROUP</span> <span class="no">BY</span> <span class="n">start_station_name</span> 
   <span class="no">HAVING</span> <span class="n">trip_count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">;</span>
   
   <span class="n">start_duration_name</span>   <span class="o">|</span> <span class="n">trip_count</span> 
   <span class="o">----------------------------------</span> 
   <span class="no">Liberty</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="no">Broadway</span> <span class="o">|</span> <span class="mi">149199</span>     
   <span class="no">W</span> <span class="mi">45</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="mi">6</span> <span class="no">Ave</span>       <span class="o">|</span> <span class="mi">118394</span>     
   <span class="no">Henry</span> <span class="no">St</span> <span class="o">&amp;</span> <span class="no">Grand</span> <span class="no">St</span>   <span class="o">|</span> <span class="mi">105108</span>     
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>What is the rolling average trip duration for each bike?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">SELECT</span> 
      <span class="n">bikeid</span><span class="p">,</span> 
      <span class="no">DATE</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="n">as</span> <span class="n">trip_date</span><span class="p">,</span> 
      <span class="n">tripduration</span><span class="p">,</span> 
      <span class="no">AVG</span><span class="p">(</span><span class="n">tripduration</span><span class="p">)</span> <span class="no">OVER</span> <span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">bikeid</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">starttime</span> <span class="no">ROWS</span> <span class="no">BETWEEN</span> <span class="mi">7</span> <span class="no">PRECEDING</span> <span class="no">AND</span> <span class="no">CURRENT</span> <span class="no">ROW</span><span class="p">)</span> <span class="no">AS</span> <span class="n">rolling_avg</span> 
      <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span> <span class="p">;</span>

   <span class="n">bikeid</span> <span class="o">|</span> <span class="n">trip_date</span>  <span class="o">|</span> <span class="n">tripduration</span> <span class="o">|</span> <span class="n">rolling_avg</span>
   <span class="o">------------------------------------------------</span>
   <span class="mi">23076</span>  <span class="o">|</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">04</span> <span class="o">|</span> <span class="mi">468</span>          <span class="o">|</span> <span class="mf">505.2</span>      
   <span class="mi">23076</span>  <span class="o">|</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">04</span> <span class="o">|</span> <span class="mi">332</span>          <span class="o">|</span> <span class="mf">869.8</span>
   <span class="mi">23076</span>  <span class="o">|</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="o">|</span> <span class="mi">729</span>          <span class="o">|</span> <span class="mf">588.8</span>
   
   </code></pre></figure>

</details>
<p><br /></p>

<p><strong>What are the top 3 longest trips for each station?</strong></p>

<details>
<summary>Show Answer</summary>
   
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      
   <span class="no">WITH</span> <span class="n">ranked_trips</span> <span class="no">AS</span> <span class="p">(</span>
      <span class="no">SELECT</span>
         <span class="n">start_station_id</span><span class="p">,</span>
         <span class="n">tripduration</span><span class="p">,</span>
         <span class="no">ROW_NUMBER</span><span class="p">()</span> <span class="no">OVER</span> <span class="p">(</span><span class="no">PARTITION</span> <span class="no">BY</span> <span class="n">start_station_id</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">tripduration</span> <span class="no">DESC</span><span class="p">)</span> <span class="no">AS</span> <span class="n">rank</span>
      <span class="no">FROM</span> <span class="sb">`bigquery-public-data.new_york_citibike.citibike_trips`</span>
   <span class="p">)</span>
   <span class="no">SELECT</span>
      <span class="n">start_station_id</span><span class="p">,</span>
      <span class="n">tripduration</span>
   <span class="no">FROM</span> <span class="n">ranked_trips</span>
   <span class="no">WHERE</span> <span class="n">rank</span> <span class="o">&lt;=</span> <span class="mi">3</span>
   <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">start_station_id</span><span class="p">,</span> <span class="n">tripduration</span> <span class="no">DESC</span><span class="p">;</span>

   <span class="n">start_station_id</span> <span class="o">|</span> <span class="n">tripduration</span>
   <span class="o">-------------------------------</span>
   <span class="mi">72</span>               <span class="o">|</span> <span class="mi">2006840</span> 
   <span class="mi">72</span>               <span class="o">|</span> <span class="mi">792782</span>  
   <span class="mi">72</span>               <span class="o">|</span> <span class="mi">594321</span>  
   
   </code></pre></figure>

</details>
<p><br /></p>

<p>With this we have reached the end of this post, I hope you enjoyed it!</p>

<p>If you have any remarks or questions, please don’t hesitate and do drop a comment below.</p>

<p><em>Stay tuned!</em></p>

<h2 id="recap">Recap</h2>

<p>In this article, we explored on a high level topics of different difficulty levels of the SQL language. Hopefully the examples and the case study helped in clarifying these concepts but this is only the tip of the iceberg. Writing clearer and more efficient SQL queries requires practice. The resources section contains valuable materials to support you further in your learning journey.</p>

<p><em>Happy learning!</em></p>

<h2 id="resources">Resources</h2>

<p><a href="https://en.wikipedia.org/wiki/Query_plan">https://en.wikipedia.org/wiki/Query_plan</a></p>

<p><a href="https://sqlzoo.net/wiki/SQL_Tutorial">https://sqlzoo.net/wiki/SQL_Tutorial</a></p>

<p><a href="https://www.windowfunctions.com/">https://www.windowfunctions.com/</a></p>

<p><a href="https://datalemur.com/sql-tutorial">https://datalemur.com/sql-tutorial</a></p>

<p><a href="https://selectstarsql.com/">https://selectstarsql.com/</a></p>

  </div>

  <hr>
<br>
<div class="ml-embedded" data-form="T82iSQ"></div>

  <br>
<hr>
<br>
<div id="relatedPosts">
   <div class="post-header bg-">
      <h1 class="page-heading">Further Reading</h1>
   </div>
   
   
   
   
   
    
    
    
   
    
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2024/12/08/system-design-interview-blueprint.html">System Desing Interview Blueprint</a></h3>
    </div>
    
    
   
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2024/11/17/evolution-analytical-data-architectures.html">Evolution of Analytical Data Architectures: From Data Warehouses to Lakehouses</a></h3>
    </div>
    
    
   
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2024/08/11/data-warehouse-modeling-techniques.html">Data Warehouse Modeling Techniques</a></h3>
    </div>
    
    
   
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
   
    
    
    
   
    
    <div>
      <h3><a href="/articles/2023/09/24/data-processing-architectures-lambda-vs-kappa.html">Data Processing Architectures: Lambda vs Kappa</a></h3>
    </div>
    
    
        
</div>

  
    
<hr>
<br>
<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://firasesbai.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

  <a class="u-url" href="/articles/2024/12/30/level-up-sql-skills-data-engineer.html" hidden></a>
</article>
      </div>
    </main><link rel="stylesheet" href="/assets/css/footer.css">
 
<footer class="site-footer h-card">
   <data class="u-url" href="/"></data>
   <div class="wrapper">
      <div class="footer-col-wrapper">
         <div class="footer-col footer-col-1" style="text-align: left;"><ul class="social-media-list"><li><a href="https://www.firasesbai.com/feed.xml"><svg class="svg-icon orange"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg><span> Subscribe</span></a></li><li><a href="https://www.linkedin.com/in/firas-esbai"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">firas-esbai</span></a></li><li><a href="https://github.com/firasesbai"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">firasesbai</span></a></li></ul></div>
         <div class="footer-col footer-col-2" style="text-align: right;">
            <ul class="legal-list" style="list-style-type: none; padding: 0;">
               <li><a href="/archive/">Archive</a></li>
               <li><a href="/privacy-policy/">Privacy Policy</a></li>
               <li><a href="/terms/">Terms and Conditions</a></li>
            </ul>
         </div>
      </div>
      <div style="text-align: center; margin-top: 10px;">
         
            <p class="p-name">Copyright &copy; 2024 Firas Esbai.</p>
            
      </div>
   </div>
</footer><!-- Cookie Consent Logic -->	
	<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
	<script src="/js/cookie-consent-script.js" type="text/javascript"> </script>

  </body>

</html>