<br>
<hr>
<br>
<div id="relatedPosts">
   <div class="post-header bg-{{site.default_post_color}}">
      <h1 class="page-heading">Further Reading</h1>
   </div>
   {% assign maxRelated = 4 %}
   {% assign minCommonTags = 1 %}
   
   {%- comment -%}Build array of related posts with scores{%- endcomment -%}
   {% assign related_posts_array = "" | split: "" %}
   
   {% for post in site.posts %}
    {% if post.url != page.url %}
      {% assign sameTagCount = 0 %}
      {% assign commonTags = '' %}
      
      {% for tag in post.tags %}
        {% if page.tags contains tag %}
          {% assign sameTagCount = sameTagCount | plus: 1 %}
          {% capture tagmarkup %} <span class="tag-badge">{{ tag }}</span> {% endcapture %}
          {% assign commonTags = commonTags | append: tagmarkup %}
        {% endif %}
      {% endfor %}
      
      {%- comment -%}Add post to array if it has common tags{%- endcomment -%}
      {% if sameTagCount >= minCommonTags %}
        {%- comment -%}Create sortable key: score + URL{%- endcomment -%}
        {% assign score_padded = sameTagCount | prepend: "000" | slice: -3, 3 %}
        {% assign sort_key = score_padded | append: "|||" | append: post.url | append: "|||" | append: commonTags %}
        {% assign related_posts_array = related_posts_array | push: sort_key %}
      {% endif %}
    {% endif %}
   {% endfor %}
   
   {%- comment -%}Sort by score (descending) and display{%- endcomment -%}
   {% assign sorted_related = related_posts_array | sort | reverse %}
   
   {% for item in sorted_related limit:maxRelated %}
     {% assign parts = item | split: "|||" %}
     {% assign post_url = parts[1] %}
     {% assign tags = parts[2] %}
     
     {%- comment -%}Find the actual post object{%- endcomment -%}
     {% for post in site.posts %}
       {% if post.url == post_url %}
         <div class="related-post-item">
           <h3><a href="{{ site.baseurl }}{{ post.url }}">{{ post.title }}</a></h3>
           <p class="related-meta">
             <span class="related-date">{{ post.date | date: "%B %d, %Y" }}</span>
             <span class="related-tags">{{ tags }}</span>
           </p>
         </div>
         {% break %}
       {% endif %}
     {% endfor %}
   {% endfor %}
   
   {%- comment -%}Show message if no related posts{%- endcomment -%}
   {% if related_posts_array.size == 0 %}
     <p class="no-related">No related posts found. <a href="/archive/">Explore the archive</a> to discover more articles.</p>
   {% endif %}
</div>